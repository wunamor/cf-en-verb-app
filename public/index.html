<!DOCTYPE html>
<html lang="zh-CN">
	<head>
		<meta charset="UTF-8" />
		<meta
			name="viewport"
			content="width=device-width, initial-scale=1.0"
		/>
		<title>è‹±è¯­åŠ¨è¯åŠ©æ‰‹ Pro</title>
		<link
			rel="icon"
			href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><rect width=%22100%22 height=%22100%22 rx=%2220%22 fill=%22%233b82f6%22/><path d=%22M28 38 L50 72 L72 38%22 fill=%22none%22 stroke=%22white%22 stroke-width=%2212%22 stroke-linecap=%22round%22 stroke-linejoin=%22round%22/><circle cx=%2272%22 cy=%2228%22 r=%228%22 fill=%22%23a5f3fc%22/></svg>"
		/>
		<style>
			:root {
				--bg-body: #0f172a; /* æ·±è“é»‘èƒŒæ™¯ */
				--bg-card: #1e293b; /* å¡ç‰‡èƒŒæ™¯ */
				--bg-hover: #334155; /* æ‚¬åœé«˜äº® */
				--text-main: #f8fafc; /* ä¸»æ–‡å­— */
				--text-sub: #94a3b8; /* å‰¯æ–‡å­— */
				--primary: #3b82f6; /* äº®è“è‰² */
				--primary-hover: #2563eb;
				--danger: #ef4444; /* çº¢è‰² */
				--border: #334155; /* è¾¹æ¡†è‰² */
				--input-bg: #0f172a; /* è¾“å…¥æ¡†èƒŒæ™¯ */
			}

			body {
				font-family: 'Segoe UI', system-ui, sans-serif;
				background: var(--bg-body);
				color: var(--text-main);
				padding: 20px;
				max-width: 1000px;
				margin: 0 auto;
				line-height: 1.6;
			}

			/* --- æ ¸å¿ƒç»„ä»¶ --- */
			.card {
				background: var(--bg-card);
				border: 1px solid var(--border);
				border-radius: 10px;
				padding: 20px;
				margin-bottom: 20px;
				box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.5);
			}

			.btn {
				padding: 8px 16px;
				border-radius: 6px;
				border: 1px solid transparent;
				cursor: pointer;
				font-size: 0.9rem;
				transition: 0.2s;
				display: inline-flex;
				align-items: center;
				justify-content: center;
				font-weight: 500;
				white-space: nowrap;
			}
			.btn-primary {
				background: var(--primary);
				color: white;
			}
			.btn-primary:hover {
				background: var(--primary-hover);
			}
			.btn-danger {
				background: rgba(239, 68, 68, 0.15);
				color: #fca5a5;
				border: 1px solid var(--danger);
			}
			.btn-danger:hover {
				background: var(--danger);
				color: white;
			}
			.btn-outline {
				background: transparent;
				border: 1px solid var(--border);
				color: var(--text-sub);
			}
			.btn-outline:hover {
				border-color: var(--text-main);
				color: var(--text-main);
				background: var(--bg-hover);
			}
			.btn-sm {
				padding: 4px 10px;
				font-size: 0.8rem;
				margin-left: 5px;
			}
			.btn:disabled {
				opacity: 0.6;
				cursor: not-allowed;
			}

			.input,
			select {
				background: var(--input-bg);
				border: 1px solid var(--border);
				color: white;
				padding: 10px;
				border-radius: 6px;
				width: 100%;
				box-sizing: border-box;
				outline: none;
				transition: border-color 0.2s;
			}
			.input:focus {
				border-color: var(--primary);
			}
			select {
				cursor: pointer;
			}

			/* é€šç”¨ Flex å¸ƒå±€ (PCé»˜è®¤æ¨ªå‘) */
			.flex {
				display: flex;
				gap: 10px;
				align-items: center;
				flex-wrap: wrap;
			}
			.hidden {
				display: none !important;
			}
			.text-primary {
				color: var(--primary);
				font-weight: 600;
			}

			/* --- é¡¶éƒ¨ä¸æœç´¢ --- */
			/* æ ¸å¿ƒä¿®å¤ï¼šjustify-content: space-between ç¡®ä¿å·¦å³å¯¹é½ */
			.header {
				display: flex;
				justify-content: space-between;
				margin-bottom: 20px;
				align-items: center;
			}
			.search-area {
				display: flex;
				gap: 10px;
				width: 100%;
			}

			/* --- è¡¨æ ¼æ ·å¼ --- */
			table {
				width: 100%;
				border-collapse: collapse;
				margin-top: 5px;
			}
			th {
				text-align: left;
				background: #0f172a;
				padding: 12px;
				color: var(--text-sub);
				font-size: 0.85rem;
				border-bottom: 2px solid var(--border);
				font-weight: 600;
			}
			td {
				padding: 14px 12px;
				border-bottom: 1px solid var(--border);
				font-size: 0.95rem;
				color: #e2e8f0;
			}
			tr:hover td {
				background: var(--bg-hover);
			}

			input[type='checkbox'] {
				accent-color: var(--primary);
				width: 16px;
				height: 16px;
				cursor: pointer;
			}

			/* --- åˆ†é¡µæ  (æ ¸å¿ƒä¿®å¤ï¼šé»˜è®¤æ¨ªå‘) --- */
			.footer {
				display: flex;
				justify-content: space-between; /* å·¦å³åˆ†å¸ƒ */
				align-items: center;
				margin-top: 20px;
				padding-top: 15px;
				border-top: 1px solid var(--border);
			}
			.page-ctrl {
				display: flex;
				gap: 8px;
				align-items: center;
			}

			.page-btn {
				min-width: 32px;
				height: 32px;
				display: flex;
				justify-content: center;
				align-items: center;
				border: 1px solid var(--border);
				border-radius: 4px;
				cursor: pointer;
				color: var(--text-sub);
				background: var(--bg-body);
				user-select: none;
				font-size: 0.9rem;
				transition: all 0.2s;
			}
			.page-btn:hover:not(.active) {
				border-color: var(--text-main);
				color: var(--text-main);
			}

			/* æ ¸å¿ƒä¿®å¤ï¼šæ¿€æ´»çŠ¶æ€æ ·å¼å¿…é¡»è¶³å¤Ÿå¼º */
			.page-btn.active {
				background: var(--primary) !important;
				border-color: var(--primary) !important;
				color: white !important;
				font-weight: bold;
			}
			.page-input {
				width: 45px;
				text-align: center;
				padding: 4px;
				height: 32px;
				font-size: 0.9rem;
			}

			/* --- å¯¼å…¥é¢æ¿ --- */
			.import-box {
				background: #0f172a;
				padding: 15px;
				border-radius: 8px;
				border: 1px solid var(--border);
			}
			/* PCç«¯å¯¼å…¥è¡Œé»˜è®¤æ¨ªå‘ */
			.import-row {
				display: flex;
				gap: 15px;
				margin-bottom: 15px;
			}
			.import-col {
				flex: 1;
				min-width: 200px;
			}

			.mapping-row {
				display: grid;
				grid-template-columns: 100px 1fr;
				gap: 15px;
				align-items: center;
				margin-bottom: 10px;
			}
			.mapping-label {
				text-align: right;
				color: var(--text-sub);
				font-size: 0.9rem;
			}

			/* --- å¼¹çª— (Modal) --- */
			.modal-mask {
				position: fixed;
				inset: 0;
				background: rgba(0, 0, 0, 0.6);
				display: flex;
				justify-content: center;
				align-items: center;
				z-index: 999;
				backdrop-filter: blur(3px);
			}
			.modal {
				background: var(--bg-card);
				width: 450px;
				padding: 25px;
				border-radius: 12px;
				border: 1px solid var(--border);
				box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.5);
				animation: popIn 0.2s ease-out;
			}
			@keyframes popIn {
				from {
					opacity: 0;
					transform: scale(0.95);
				}
				to {
					opacity: 1;
					transform: scale(1);
				}
			}

			.modal-title {
				margin: 0 0 10px 0;
				font-size: 1.1rem;
				color: var(--text-main);
			}
			.modal-body {
				color: var(--text-sub);
				margin-bottom: 25px;
				font-size: 0.95rem;
				line-height: 1.6;
			}
			.modal-btns {
				display: flex;
				justify-content: flex-end;
				gap: 10px;
			}

			/* --- Toast --- */
			.toast {
				position: fixed;
				top: 20px;
				right: 20px;
				background: #10b981;
				color: white;
				padding: 12px 24px;
				border-radius: 8px;
				transform: translateY(-100px);
				transition: 0.3s;
				z-index: 1000;
				box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3);
			}
			.toast.show {
				transform: translateY(0);
			}
			.toast.error {
				background: var(--danger);
			}

			/* è¿›åº¦æ¡ */
			.progress-track {
				background: var(--bg-body);
				border: 1px solid var(--border);
				height: 10px;
				border-radius: 5px;
				overflow: hidden;
				margin: 10px 0;
			}
			.progress-fill {
				background: var(--primary);
				height: 100%;
				width: 0%;
				transition: width 0.3s;
			}

			/* =========================================
       ç§»åŠ¨ç«¯é€‚é… (Max-Width: 768px)
       æ‰€æœ‰çš„ç«–æ’ã€å †å é€»è¾‘åªåœ¨è¿™é‡Œç”Ÿæ•ˆ
       ========================================= */
			@media (max-width: 768px) {
				body {
					padding: 10px;
				}

				/* 1. é¡¶éƒ¨ Header ä¿æŒå·¦å³åˆ†å¸ƒ (æ ¸å¿ƒä¿®æ”¹) */
				/* ç§»é™¤ flex-direction: columnï¼Œç»§æ‰¿ PC çš„ row */
				.header {
					gap: 10px;
					/* é˜²æ­¢å°å±å¹•æ–‡å­—æ‹¥æŒ¤ï¼Œé€‚å½“ç¼©å°æ ‡é¢˜ */
				}
				.header h2 {
					font-size: 1.2rem;
				}
				.header h2 span {
					display: none;
				} /* æ‰‹æœºä¸Šéšè— "Pro" æ ‡ç­¾ä»¥èŠ‚çœç©ºé—´ */

				/* 2. æœç´¢æ¡†ç«–æ’ */
				.search-area {
					flex-direction: column;
				}
				.search-area button {
					width: 100%;
				}

				/* 3. æ‰¹é‡å¯¼å…¥ç«–æ’ */
				.import-row {
					flex-direction: column;
					gap: 10px;
				}

				/* 4. åˆ†é¡µæ ç«–æ’è½¬å±…ä¸­ */
				.footer {
					flex-direction: column;
					gap: 15px;
				}
				.page-ctrl {
					flex-wrap: wrap;
					justify-content: center;
					width: 100%;
				}

				/* 5. è¡¨æ ¼å˜å¡ç‰‡ */
				thead {
					display: none;
				}
				tr {
					display: block;
					background: var(--bg-card);
					border: 1px solid var(--border);
					margin-bottom: 15px;
					border-radius: 8px;
					padding: 10px;
				}
				td {
					display: flex;
					justify-content: space-between;
					align-items: center;
					padding: 8px 0;
					border-bottom: 1px solid #33415540;
					text-align: right;
				}
				td:last-child {
					border-bottom: none;
				}
				td::before {
					content: attr(data-label);
					color: var(--text-sub);
					font-size: 0.85rem;
					font-weight: 600;
					text-align: left;
					margin-right: 15px;
				}

				/* 6. å¼¹çª—é€‚é… */
				.modal {
					width: 90%;
					padding: 20px;
				}
				.modal-btns {
					flex-direction: column;
				}
				.modal-btns button {
					width: 100%;
				}
			}
		</style>
	</head>
	<body>
		<div class="header">
			<h2 style="margin: 0; display: flex; align-items: center; gap: 12px; font-weight: 700">
				<svg
					width="36"
					height="36"
					viewBox="0 0 100 100"
					fill="none"
					xmlns="http://www.w3.org/2000/svg"
				>
					<rect
						width="100"
						height="100"
						rx="24"
						fill="#3b82f6"
					/>
					<path
						d="M28 38 L50 72 L72 38"
						stroke="white"
						stroke-width="12"
						stroke-linecap="round"
						stroke-linejoin="round"
					/>
					<circle
						cx="72"
						cy="28"
						r="8"
						fill="#a5f3fc"
					/>
				</svg>
				<span
					style="
						background: linear-gradient(to right, #fff, #94a3b8);
						-webkit-background-clip: text;
						color: transparent;
					"
				>
					åŠ¨è¯ç®¡ç†å™¨
					<span
						style="
							font-size: 0.6em;
							color: #3b82f6;
							border: 1px solid #3b82f6;
							padding: 2px 6px;
							border-radius: 4px;
							vertical-align: middle;
							margin-left: 5px;
						"
						>Pro</span
					>
				</span>
			</h2>
			<div>
				<button
					id="loginBtn"
					class="btn btn-primary"
					onclick="showLogin()"
				>
					ç®¡ç†å‘˜ç™»å½•
				</button>
				<button
					id="logoutBtn"
					class="btn btn-outline hidden"
					onclick="confirmLogout()"
				>
					é€€å‡ºç™»å½•
				</button>
			</div>
		</div>

		<div class="card">
			<div class="search-area">
				<input
					id="searchInput"
					class="input"
					style="flex: 1"
					placeholder="è¾“å…¥å•è¯ (æ”¯æŒæ¨¡ç³Šæœç´¢)..."
					onkeydown="if(event.key==='Enter') resetSearch()"
				/>
				<button
					class="btn btn-primary"
					onclick="resetSearch()"
				>
					æŸ¥è¯¢
				</button>
				<button
					class="btn btn-outline"
					onclick="showExportModal()"
				>
					å¯¼å‡ºï¼ˆæ ¹æ®æŸ¥è¯¢ç»“æœï¼‰
				</button>
			</div>

			<div style="margin-top: 15px; font-size: 0.9rem; color: var(--text-sub); display: flex; gap: 20px">
				<span>åŒ¹é…æ¨¡å¼ï¼š</span>
				<label style="cursor: pointer; display: flex; align-items: center; gap: 5px">
					<input
						type="radio"
						name="mode"
						value="fuzzy"
						checked
						onchange="resetSearch()"
					/>
					æ¨¡ç³ŠåŒ¹é…
				</label>
				<label style="cursor: pointer; display: flex; align-items: center; gap: 5px">
					<input
						type="radio"
						name="mode"
						value="exact"
						onchange="resetSearch()"
					/>
					ç²¾ç¡®åŒ¹é…
				</label>
			</div>
		</div>

		<div
			id="resultArea"
			class="hidden"
		>
			<div
				class="card"
				style="padding: 0; overflow: hidden"
			>
				<div id="tableContainer"></div>

				<div
					class="footer"
					style="padding: 15px"
				>
					<div class="flex">
						<span style="color: var(--text-sub); font-size: 0.9rem">æ¯é¡µæ˜¾ç¤º:</span>
						<select
							id="pageSize"
							style="width: 70px; padding: 4px"
							class="input"
							onchange="resetSearch()"
						>
							<option value="5">5</option>
							<option
								value="10"
								selected
							>
								10
							</option>
							<option value="20">20</option>
							<option value="50">50</option>
						</select>
					</div>

					<div
						class="page-ctrl"
						id="pagination"
					></div>
				</div>
			</div>
		</div>

		<div
			id="adminPanel"
			class="hidden"
		>
			<div
				class="flex"
				style="margin-bottom: 15px"
			>
				<button
					class="btn btn-primary"
					onclick="switchTab('single')"
				>
					å•æ¡æ·»åŠ 
				</button>
				<button
					class="btn btn-outline"
					onclick="switchTab('batch')"
				>
					æ‰¹é‡å¯¼å…¥
				</button>
			</div>

			<div
				id="tab-single"
				class="card"
			>
				<h3 style="margin-top: 0">âœï¸ ç¼–è¾‘/æ·»åŠ </h3>
				<input
					type="hidden"
					id="editId"
				/>

				<div
					class="flex"
					style="margin-bottom: 15px"
				>
					<input
						id="base"
						class="input"
						placeholder="åŸå½¢ (Base)"
					/>
					<input
						id="past"
						class="input"
						placeholder="è¿‡å»å¼ (Past)"
					/>
				</div>

				<div
					class="flex"
					style="margin-bottom: 15px"
				>
					<input
						id="part"
						class="input"
						placeholder="è¿‡å»åˆ†è¯ (Participle)"
					/>
					<input
						id="def"
						class="input"
						placeholder="ä¸­æ–‡é‡Šä¹‰"
					/>
				</div>

				<input
					id="note"
					class="input"
					placeholder="å¤‡æ³¨"
					style="margin-bottom: 15px"
				/>

				<div class="flex">
					<button
						class="btn btn-primary"
						onclick="saveSingle()"
					>
						æäº¤ä¿å­˜
					</button>
					<button
						id="cancelEdit"
						class="btn btn-outline hidden"
						onclick="resetForm()"
					>
						å–æ¶ˆç¼–è¾‘
					</button>
				</div>
			</div>
			<div
				id="tab-batch"
				class="card hidden"
			>
				<h3 style="margin-top: 0">ğŸ“‚ æ–‡ä»¶æ‰¹é‡å¯¼å…¥</h3>

				<div class="import-box">
					<div class="import-row">
						<div class="import-col">
							<label style="color: var(--text-sub); font-size: 0.8rem; display: block; margin-bottom: 5px"
								>1. é€‰æ‹©æ–‡ä»¶ (.txt/.csv)</label
							>
							<input
								type="file"
								id="fileInput"
								class="input"
								style="padding: 8px"
								accept=".txt,.csv"
								onchange="parseFile()"
							/>
						</div>
						<div class="import-col">
							<label style="color: var(--text-sub); font-size: 0.8rem; display: block; margin-bottom: 5px"
								>2. åˆ†éš”ç¬¦</label
							>
							<div
								class="flex"
								style="flex-wrap: nowrap"
							>
								<select
									id="delimSelect"
									class="input"
									onchange="handleDelim()"
								>
									<option value="custom">è‡ªå®šä¹‰</option>
									<option value=",">é€—å· (,)</option>
									<option value="	">Tab (åˆ¶è¡¨ç¬¦)</option>
									<option value="|">ç«–çº¿ (|)</option>
								</select>
								<input
									id="customDelim"
									class="input"
									placeholder="ç¬¦å·"
									value=","
									style="width: 80px; text-align: center"
									oninput="parseFile()"
								/>
							</div>
						</div>
					</div>

					<div style="margin-top: 15px; border-top: 1px solid var(--border); padding-top: 10px">
						<label style="color: var(--text-sub); font-size: 0.9rem">é‡åˆ°é‡å¤æ—¶ï¼š</label>
						<label style="margin-left: 10px; cursor: pointer"
							><input
								type="radio"
								name="importMode"
								value="skip"
								checked
							/>
							è·³è¿‡</label
						>
						<label style="margin-left: 10px; cursor: pointer"
							><input
								type="radio"
								name="importMode"
								value="update"
							/>
							è¦†ç›–</label
						>
					</div>
				</div>

				<div
					id="mappingArea"
					class="hidden"
					style="margin-top: 20px"
				>
					<h4 style="margin-bottom: 15px; color: var(--text-sub)">3. å­—æ®µåŒ¹é…é¢„è§ˆ</h4>
					<div id="mappingContainer"></div>

					<div style="margin-top: 20px">
						<div
							id="importProgressBar"
							class="progress-track hidden"
							style="margin-bottom: 10px"
						>
							<div
								id="importProgressFill"
								class="progress-fill"
							></div>
						</div>

						<div style="text-align: right">
							<span
								id="importStatus"
								style="margin-right: 10px; color: var(--text-sub); font-size: 0.9rem"
							></span>
							<button
								id="btnStartImport"
								class="btn btn-primary"
								onclick="executeImport()"
							>
								å¼€å§‹å¯¼å…¥
							</button>
						</div>
					</div>
				</div>
			</div>
		</div>

		<div
			id="loginModal"
			class="modal-mask hidden"
		>
			<div class="modal">
				<h3 class="modal-title">ğŸ” ç®¡ç†å‘˜éªŒè¯</h3>
				<div class="modal-body">
					<input
						type="password"
						id="modalPass"
						class="input"
						placeholder="è¯·è¾“å…¥ç®¡ç†å‘˜å¯†ç "
						onkeydown="if(event.key==='Enter') confirmLogin()"
					/>
				</div>
				<div class="modal-btns">
					<button
						class="btn btn-outline"
						onclick="closeModal('loginModal')"
					>
						å–æ¶ˆ
					</button>
					<button
						class="btn btn-primary"
						onclick="confirmLogin()"
					>
						ç¡®å®š
					</button>
				</div>
			</div>
		</div>

		<div
			id="confirmModal"
			class="modal-mask hidden"
		>
			<div class="modal">
				<h3
					class="modal-title"
					id="confirmTitle"
				>
					ç¡®è®¤æ“ä½œ
				</h3>
				<div
					class="modal-body"
					id="confirmMsg"
				>
					ç¡®å®šè¦æ‰§è¡Œæ­¤æ“ä½œå—ï¼Ÿ
				</div>
				<div class="modal-btns">
					<button
						class="btn btn-outline"
						onclick="closeModal('confirmModal')"
					>
						å–æ¶ˆ
					</button>
					<button
						class="btn btn-danger"
						id="confirmActionBtn"
					>
						ç¡®å®š
					</button>
				</div>
			</div>
		</div>

		<div
			id="toast"
			class="toast"
		>
			æ“ä½œæˆåŠŸ
		</div>

		<div
			id="exportModal"
			class="modal-mask hidden"
		>
			<div class="modal">
				<h3 class="modal-title">ğŸ“¤ å¯¼å‡ºæ•°æ®</h3>
				<div class="modal-body">
					<label style="display: block; margin-bottom: 10px; color: var(--text-sub)">é€‰æ‹©åˆ†éš”ç¬¦ï¼š</label>
					<div class="flex">
						<select
							id="exportDelimSelect"
							class="input"
							onchange="toggleExportCustom()"
						>
							<option value=",">é€—å· (CSV é»˜è®¤)</option>
							<option value="	">Tab (åˆ¶è¡¨ç¬¦)</option>
							<option value="|">ç«–çº¿ (|)</option>
							<option value="custom">è‡ªå®šä¹‰</option>
						</select>
						<input
							id="exportCustomDelim"
							class="input hidden"
							placeholder="è¾“å…¥ç¬¦å·"
							style="width: 80px"
						/>
					</div>
					<p style="margin-top: 15px; font-size: 0.85rem; color: var(--text-sub)">
						* å¯¼å‡ºå°†åŒ…å«å½“å‰æœç´¢æ¡ä»¶ä¸‹çš„æ‰€æœ‰ç»“æœã€‚<br />
						* ç©ºå­—æ®µå°†ä¿ç•™å ä½ç¬¦ (ä¾‹å¦‚: lie,lied,,å¤‡æ³¨)
					</p>
				</div>
				<div class="modal-btns">
					<button
						class="btn btn-outline"
						onclick="closeModal('exportModal')"
					>
						å–æ¶ˆ
					</button>
					<button
						id="btnExecuteExport"
						class="btn btn-primary"
						onclick="executeExport()"
					>
						ç¡®è®¤å¯¼å‡º
					</button>
				</div>
			</div>
		</div>

		<script>
			// --- æ ¸å¿ƒå˜é‡ ---
			let currentPage = 1
			let totalPages = 1
			let selectedIds = new Set()
			let csvData = []

			window.onload = () => {
				// 1. æ¢å¤ç®¡ç†å‘˜çŠ¶æ€
				if (localStorage.getItem('adminKey')) toggleAdmin(true)

				// 2. æ ¸å¿ƒä¼˜åŒ–ï¼šæ‰‹æœºç«¯é»˜è®¤æ¯é¡µæ˜¾ç¤º 5 æ¡
				if (window.innerWidth < 768) {
					const limitSelect = document.getElementById('pageSize')
					if (limitSelect) {
						limitSelect.value = '5' // å¼ºåˆ¶é€‰ä¸­ 5
					}
				}

				// 3. æ‰§è¡Œé¦–æ¬¡æœç´¢
				doSearch()
			}

			// --- 1. æœç´¢ä¸æ¸²æŸ“åˆ—è¡¨ ---
			function resetSearch() {
				currentPage = 1
				selectedIds.clear()
				doSearch()
			}

			async function doSearch() {
				const q = document.getElementById('searchInput').value.trim()
				const limit = document.getElementById('pageSize').value
				const mode = document.querySelector('input[name="mode"]:checked').value

				document.getElementById('resultArea').classList.remove('hidden')
				const container = document.getElementById('tableContainer')

				try {
					const res = await fetch(
						`/api/search?q=${encodeURIComponent(q)}&page=${currentPage}&limit=${limit}&mode=${mode}`
					)
					const json = await res.json()

					totalPages = Math.ceil((json.total || 0) / limit)
					renderTable(json.data)
					renderPagination(totalPages)
				} catch (e) {
					console.error(e)
				}
			}

			function renderTable(data) {
				const div = document.getElementById('tableContainer')
				if (!data || data.length === 0) {
					div.innerHTML = '<div style="text-align:center; padding:40px; color:var(--text-sub)">æš‚æ— æ•°æ®</div>'
					return
				}
				const isAdmin = !!localStorage.getItem('adminKey')

				// PCç«¯è¡¨å¤´ (ç§»åŠ¨ç«¯ CSS ä¼šéšè—å®ƒ)
				let th = `<thead><tr>`
				if (isAdmin) th += `<th style="width:40px"><input type="checkbox" id="selectAll" onclick="toggleAll()"></th>`
				th += `<th>åŸå½¢</th><th>è¿‡å»å¼</th><th>è¿‡å»åˆ†è¯</th><th>é‡Šä¹‰</th><th>å¤‡æ³¨</th>`
				if (isAdmin) {
					const delBtn =
						selectedIds.size > 0
							? `<button class="btn btn-danger" style="padding:2px 8px; font-size:0.8rem" onclick="batchDeleteClick()">åˆ  (${selectedIds.size})</button>`
							: `<span>æ“ä½œ</span>`
					th += `<th style="width:140px; text-align:right">${delBtn}</th>`
				}
				th += `</tr></thead>`

				// æ„å»ºå†…å®¹
				let rows = data
					.map((item) => {
						const json = JSON.stringify(item).replace(/"/g, '&quot;')
						const checked = selectedIds.has(item.id) ? 'checked' : ''

						// æ³¨æ„ï¼šè¿™é‡Œæ·»åŠ äº† data-label å±æ€§ï¼Œç”¨äºç§»åŠ¨ç«¯æ˜¾ç¤º
						let tr = `<tr>`
						if (isAdmin)
							tr += `<td data-label="é€‰æ‹©"><input type="checkbox" class="row-cb" value="${item.id}" ${checked} onclick="toggleRow(${item.id})"></td>`
						tr += `
            <td data-label="åŸå½¢" class="text-primary" style="font-weight:bold">${item.base_word}</td>
            <td data-label="è¿‡å»å¼">${item.past_tense}</td>
            <td data-label="è¿‡å»åˆ†è¯">${item.past_participle}</td>
            <td data-label="é‡Šä¹‰">${item.definition || ''}</td>
            <td data-label="å¤‡æ³¨" style="color:var(--text-sub); font-size:0.85rem">${item.note || ''}</td>
        `
						if (isAdmin)
							tr += `
            <td data-label="æ“ä½œ" style="text-align:right">
                <button class="btn btn-outline btn-sm" onclick="editItem(${json})">æ”¹</button>
                <button class="btn btn-danger btn-sm" style="margin-left:5px" onclick="delItemClick(${item.id})">åˆ </button>
            </td>
        `
						tr += `</tr>`
						return tr
					})
					.join('')

				div.innerHTML = `<table>${th}<tbody>${rows}</tbody></table>`

				// åˆ·æ–°å…¨é€‰æ¡†çŠ¶æ€
				if (isAdmin && document.getElementById('selectAll')) {
					const allRows = document.querySelectorAll('.row-cb')
					if (allRows.length > 0 && Array.from(allRows).every((cb) => cb.checked)) {
						document.getElementById('selectAll').checked = true
					}
				}
			}
			// --- 2. æ‰¹é‡æ“ä½œé€»è¾‘ ---
			function toggleAll() {
				const master = document.getElementById('selectAll')
				document.querySelectorAll('.row-cb').forEach((cb) => {
					cb.checked = master.checked
					const id = parseInt(cb.value)
					if (master.checked) selectedIds.add(id)
					else selectedIds.delete(id)
				})
				// ä»…åˆ·æ–° UI ä¸é‡æ–°è¯·æ±‚
				doSearch()
			}

			function toggleRow(id) {
				if (selectedIds.has(id)) selectedIds.delete(id)
				else selectedIds.add(id)
				doSearch()
			}

			// æ ¸å¿ƒä¿®å¤ï¼šè¿™é‡Œä½¿ç”¨ showConfirmModal è€Œä¸æ˜¯ confirm()
			function batchDeleteClick() {
				showConfirmModal(`ç¡®å®šè¦åˆ é™¤é€‰ä¸­çš„ ${selectedIds.size} ä¸ªå•è¯å—ï¼Ÿ`, async () => {
					const ids = Array.from(selectedIds)
					await fetch('/api/batch_delete', {
						method: 'POST',
						headers: { 'Admin-Key': localStorage.getItem('adminKey') },
						body: JSON.stringify({ ids }),
					})
					showToast('æ‰¹é‡åˆ é™¤æˆåŠŸ')
					selectedIds.clear()
					doSearch()
				})
			}

			// æ ¸å¿ƒä¿®å¤ï¼šè¿™é‡Œä½¿ç”¨ showConfirmModal è€Œä¸æ˜¯ confirm()
			function delItemClick(id) {
				showConfirmModal('ç¡®å®šåˆ é™¤è¿™ä¸ªå•è¯å—ï¼Ÿ', async () => {
					await fetch('/api/delete', {
						method: 'POST',
						headers: { 'Admin-Key': localStorage.getItem('adminKey') },
						body: JSON.stringify({ id }),
					})
					showToast('å·²åˆ é™¤')
					doSearch()
				})
			}

			// --- 3. å¼¹çª—æ§åˆ¶ (å…³é”®) ---
			// ä¿®æ”¹åçš„å¼¹çª—å‡½æ•°ï¼Œæ”¯æŒä¼ å…¥ HTML å†…å®¹
			function showConfirmModal(msg, actionCallback, isHtml = false) {
				const modal = document.getElementById('confirmModal')
				const msgDiv = document.getElementById('confirmMsg')

				// æ”¯æŒ HTML è¡¨æ ¼é¢„è§ˆ
				if (isHtml) {
					msgDiv.innerHTML = msg
				} else {
					msgDiv.innerText = msg
				}

				modal.classList.remove('hidden')

				const btn = document.getElementById('confirmActionBtn')
				const newBtn = btn.cloneNode(true) // æ¸…é™¤æ—§äº‹ä»¶
				btn.parentNode.replaceChild(newBtn, btn)

				newBtn.addEventListener('click', () => {
					actionCallback()
					closeModal('confirmModal')
				})
			}

			function closeModal(id) {
				document.getElementById(id).classList.add('hidden')
			}

			// --- 4. åˆ†é¡µé€»è¾‘ (å›¾äºŒ æ–¹å—é£æ ¼) ---
			// æ›¿æ¢åŸæœ‰çš„ renderPagination å‡½æ•°
			// æ›¿æ¢åŸæœ‰çš„ renderPagination å‡½æ•°
			function renderPagination(total) {
				const el = document.getElementById('pagination')
				let html = ''

				// å¼ºåˆ¶è½¬æ¢ä¸ºæ•°å­—ï¼Œè§£å†³æ ·å¼ä¸ç”Ÿæ•ˆé—®é¢˜
				const cur = parseInt(currentPage) || 1
				const totalPg = parseInt(total) || 1

				html += `<div class="page-btn" onclick="changePage(${cur - 1})">â€¹</div>`

				let start = Math.max(1, cur - 2)
				let end = Math.min(totalPg, cur + 2)

				if (end - start < 4) {
					if (start === 1) end = Math.min(totalPg, start + 4)
					else if (end === totalPg) start = Math.max(1, end - 4)
				}

				if (start > 1) {
					// æ³¨æ„è¿™é‡Œåˆ¤æ–­ active
					html += `<div class="page-btn ${1 === cur ? 'active' : ''}" onclick="changePage(1)">1</div>`
					if (start > 2)
						html += `<span style="color:var(--text-sub); padding:0 5px; display:flex; align-items:flex-end;">...</span>`
				}

				for (let i = start; i <= end; i++) {
					// æ ¸å¿ƒä¿®å¤ï¼šç¡®ä¿ i å’Œ cur éƒ½æ˜¯æ•°å­—ï¼Œæ‰èƒ½åŒ¹é…æˆåŠŸ
					const isActive = i === cur ? 'active' : ''
					html += `<div class="page-btn ${isActive}" onclick="changePage(${i})">${i}</div>`
				}

				if (end < totalPg) {
					if (end < totalPg - 1)
						html += `<span style="color:var(--text-sub); padding:0 5px; display:flex; align-items:flex-end;">...</span>`
					html += `<div class="page-btn ${
						totalPg === cur ? 'active' : ''
					}" onclick="changePage(${totalPg})">${totalPg}</div>`
				}

				html += `<div class="page-btn" onclick="changePage(${cur + 1})">â€º</div>`
				// PCç«¯æ˜¾ç¤º Go è¾“å…¥æ¡†
				html += `<input class="input page-input" id="jumpInput" placeholder="Go" onkeydown="if(event.key==='Enter') jumpPage()">`

				el.innerHTML = html
			}

			function changePage(p) {
				if (p < 1 || p > totalPages) return
				currentPage = p
				doSearch()
			}
			function jumpPage() {
				const p = parseInt(document.getElementById('jumpInput').value)
				if (p) changePage(p)
			}

			// --- 5. å¯¼å…¥é€»è¾‘ (æ–‡ä»¶æ¸…ç©ºä¿®å¤) ---
			function handleDelim() {
				const val = document.getElementById('delimSelect').value
				const custom = document.getElementById('customDelim')
				if (val === 'custom') {
					custom.style.display = 'block'
					custom.focus()
				} else {
					custom.value = val
				}
				parseFile()
			}

			function parseFile() {
				const fileInput = document.getElementById('fileInput')
				const file = fileInput.files[0]

				// æ ¸å¿ƒä¿®å¤ï¼šå¦‚æœç”¨æˆ·æ¸…ç©ºäº†æ–‡ä»¶é€‰æ‹©ï¼Œç«‹å³é‡ç½®ç•Œé¢
				if (!file) {
					csvData = []
					document.getElementById('mappingArea').classList.add('hidden')
					document.getElementById('mappingContainer').innerHTML = ''
					return
				}

				const delim = document.getElementById('customDelim').value
				if (!delim) return

				const reader = new FileReader()
				reader.onload = (e) => {
					const text = e.target.result
					const lines = text.split(/\r?\n/).filter((l) => l.trim())
					csvData = lines.map((l) => l.split(delim).map((c) => c.trim()))
					if (csvData.length > 0) renderMapping(csvData[0])
				}
				reader.readAsText(file)
			}

			function renderMapping(previewRow) {
				document.getElementById('mappingArea').classList.remove('hidden')
				const container = document.getElementById('mappingContainer')
				container.innerHTML = ''

				const fields = [
					{ k: 'base', t: 'å•è¯åŸå½¢ (Base)' },
					{ k: 'past', t: 'è¿‡å»å¼ (Past)' },
					{ k: 'part', t: 'è¿‡å»åˆ†è¯' },
					{ k: 'def', t: 'ä¸­æ–‡é‡Šä¹‰' },
					{ k: 'note', t: 'å¤‡æ³¨' },
				]

				let opts = `<option value="">(å¿½ç•¥æ­¤å­—æ®µ)</option>`
				previewRow.forEach((v, i) => {
					opts += `<option value="${i}">åˆ— ${i + 1}: ${v.substring(0, 15)}...</option>`
				})

				fields.forEach((f, idx) => {
					const selected = idx < previewRow.length ? `value="${idx}" selected` : ''
					const html = `
                    <div class="mapping-row">
                        <div class="mapping-label">${f.t}</div>
                        <select class="input map-select" data-key="${f.k}">
                            ${opts.replace(`value="${idx}"`, selected)}
                        </select>
                    </div>
                `
					container.innerHTML += html
				})
			}

			async function executeImport() {
				const selects = document.querySelectorAll('.map-select')
				const map = {}
				selects.forEach((s) => {
					if (s.value) map[s.dataset.key] = s.value
				})

				if (!map.base) return showToast('å¿…é¡»æ˜ å°„åŸå½¢å­—æ®µ', 'error')

				const mode = document.querySelector('input[name="importMode"]:checked').value
				// è¿‡æ»¤å¹¶æ„å»º payload
				const payload = csvData
					.map((r) => ({
						base: r[map.base] || '',
						past: r[map.past] || '',
						part: r[map.part] || '',
						def: r[map.def] || '',
						note: r[map.note] || '',
					}))
					.filter((i) => i.base)

				// è·å– DOM å…ƒç´ 
				const btn = document.getElementById('btnStartImport')
				const status = document.getElementById('importStatus')
				const pBar = document.getElementById('importProgressBar')
				const pFill = document.getElementById('importProgressFill')

				// --- 1. é”å®šç•Œé¢ä¸åˆå§‹åŒ– ---
				btn.disabled = true // ç¦ç”¨æŒ‰é’®
				btn.style.opacity = '0.6'
				btn.innerText = 'å¯¼å…¥ä¸­...'

				pBar.classList.remove('hidden') // æ˜¾ç¤ºè¿›åº¦æ¡
				pFill.style.width = '0%'
				status.innerText = 'å‡†å¤‡å¼€å§‹...'

				const BATCH = 50
				let processedCount = 0
				let hasError = false

				try {
					for (let i = 0; i < payload.length; i += BATCH) {
						const chunk = payload.slice(i, i + BATCH)

						await fetch('/api/batch_add', {
							method: 'POST',
							headers: { 'Admin-Key': localStorage.getItem('adminKey') },
							body: JSON.stringify({ rows: chunk, mode }),
						})

						// --- 2. æ›´æ–°è¿›åº¦ ---
						processedCount += chunk.length
						const percent = Math.min(100, Math.round((processedCount / payload.length) * 100))

						// æ›´æ–° UI
						pFill.style.width = percent + '%'
						status.innerText = `æ­£åœ¨å¤„ç†: ${percent}% (${processedCount}/${payload.length})`
					}

					status.innerText = `å®Œæˆï¼å…± ${payload.length} æ¡`
					showToast('å¯¼å…¥æˆåŠŸ')

					// æˆåŠŸåå»¶è¿Ÿåˆ·æ–°
					setTimeout(() => {
						resetSearch()
						document.getElementById('fileInput').value = ''
						parseFile() // é‡ç½®æ˜ å°„åŒº
						// éšè—è¿›åº¦æ¡
						pBar.classList.add('hidden')
						status.innerText = ''
					}, 1500)
				} catch (e) {
					console.error(e)
					status.innerText = 'ä¸Šä¼ ä¸­æ–­ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ'
					showToast('å¯¼å…¥å¤±è´¥', 'error')
					hasError = true
				} finally {
					// --- 3. æ¢å¤æŒ‰é’®çŠ¶æ€ ---
					btn.disabled = false
					btn.style.opacity = '1'
					btn.innerText = 'å¼€å§‹å¯¼å…¥'
				}
			}

			// --- 6. é€šç”¨ç®¡ç† ---
			function switchTab(t) {
				document.getElementById('tab-single').classList.toggle('hidden', t !== 'single')
				document.getElementById('tab-batch').classList.toggle('hidden', t !== 'batch')
			}
			function editItem(item) {
				document.getElementById('editId').value = item.id
				document.getElementById('base').value = item.base_word
				document.getElementById('past').value = item.past_tense
				document.getElementById('part').value = item.past_participle
				document.getElementById('def').value = item.definition
				document.getElementById('note').value = item.note || ''
				document.getElementById('adminPanel').classList.remove('hidden')
				switchTab('single')
				document.getElementById('cancelEdit').classList.remove('hidden')
				document.getElementById('adminPanel').scrollIntoView({ behavior: 'smooth' })
			}
			// æ›¿æ¢åŸæœ‰çš„ saveSingle å‡½æ•°
			// æ›¿æ¢ index.html ä¸­çš„ saveSingle å‡½æ•°
			async function saveSingle() {
				const id = document.getElementById('editId').value
				const body = {
					id,
					base: document.getElementById('base').value.trim(),
					past: document.getElementById('past').value.trim(),
					part: document.getElementById('part').value.trim(),
					def: document.getElementById('def').value.trim(),
					note: document.getElementById('note').value.trim(),
				}

				if (!body.base || !body.past || !body.part) {
					return showToast('è¯·å¡«å†™å®Œæ•´ (åŸå½¢/è¿‡å»å¼/è¿‡å»åˆ†è¯)', 'error')
				}

				// --- åœºæ™¯ 1: ç¼–è¾‘æ¨¡å¼ (æœ‰ ID) ---
				if (id) {
					await fetch('/api/update', {
						method: 'POST',
						headers: { 'Admin-Key': localStorage.getItem('adminKey') },
						body: JSON.stringify(body),
					})
					showToast('ä¿®æ”¹æˆåŠŸ')
					resetSearch()
					resetForm()
					return
				}

				// --- åœºæ™¯ 2: æ–°å¢æ¨¡å¼ (æ—  ID) ---
				// 2.1 å…ˆæŸ¥é‡
				const searchRes = await fetch(`/api/search?q=${encodeURIComponent(body.base)}&mode=exact`)
				const searchJson = await searchRes.json()

				// 2.2 ç²¾ç¡®æ¯”å¯¹ï¼šåŸå½¢ + è¿‡å»å¼ éƒ½ç›¸åŒæ‰ç®—é‡å¤
				const duplicate = searchJson.data.find(
					(item) =>
						item.base_word.toLowerCase() === body.base.toLowerCase() &&
						item.past_tense.toLowerCase() === body.past.toLowerCase()
				)

				// 2.3 è¾…åŠ©å‡½æ•°ï¼šæ‰§è¡Œä¿å­˜
				const doAdd = async (mode) => {
					await fetch('/api/batch_add', {
						method: 'POST',
						headers: { 'Admin-Key': localStorage.getItem('adminKey') },
						body: JSON.stringify({ rows: [body], mode: mode }),
					})
					showToast(mode === 'update' ? 'å·²è¦†ç›–å¹¶ä¿å­˜' : 'ä¿å­˜æˆåŠŸ')
					resetSearch()
					resetForm()
				}

				// 2.4 å¦‚æœå‘ç°é‡å¤ -> å¼¹å‡ºé¢„è§ˆæ¡†
				if (duplicate) {
					// æ„å»ºå¯¹æ¯”è¡¨æ ¼ HTML
					const tableHtml = `
            <div style="margin-bottom:10px; color:var(--text-main)">æ£€æµ‹åˆ°å·²å­˜åœ¨çš„å•è¯å½¢å¼ï¼Œæ˜¯å¦è¦†ç›–ï¼Ÿ</div>
            <table style="width:100%; border:1px solid var(--border); font-size:0.9rem;">
                <tr style="background:var(--bg-body); color:var(--text-sub)">
                    <th style="padding:8px">å­—æ®µ</th>
                    <th style="padding:8px">å½“å‰å­˜åœ¨ (Old)</th>
                    <th style="padding:8px; color:var(--primary)">å‡†å¤‡æäº¤ (New)</th>
                </tr>
                <tr>
                    <td style="padding:8px; color:var(--text-sub)">åŸå½¢</td>
                    <td style="padding:8px">${duplicate.base_word}</td>
                    <td style="padding:8px; font-weight:bold">${body.base}</td>
                </tr>
                <tr>
                    <td style="padding:8px; color:var(--text-sub)">è¿‡å»å¼</td>
                    <td style="padding:8px">${duplicate.past_tense}</td>
                    <td style="padding:8px; font-weight:bold">${body.past}</td>
                </tr>
                <tr>
                    <td style="padding:8px; color:var(--text-sub)">è¿‡å»åˆ†è¯</td>
                    <td style="padding:8px">${duplicate.past_participle}</td>
                    <td style="padding:8px; color:${
											duplicate.past_participle !== body.part ? 'var(--primary)' : 'inherit'
										}">${body.part}</td>
                </tr>
                <tr>
                    <td style="padding:8px; color:var(--text-sub)">é‡Šä¹‰</td>
                    <td style="padding:8px">${duplicate.definition || '-'}</td>
                    <td style="padding:8px; color:${
											(duplicate.definition || '') !== body.def ? 'var(--primary)' : 'inherit'
										}">${body.def}</td>
                </tr>
                <tr>
                    <td style="padding:8px; color:var(--text-sub)">å¤‡æ³¨</td>
                    <td style="padding:8px">${duplicate.note || '-'}</td>
                    <td style="padding:8px; color:${
											(duplicate.note || '') !== body.note ? 'var(--primary)' : 'inherit'
										}">${body.note}</td>
                </tr>
            </table>
            <div style="margin-top:10px; font-size:0.8rem; color:var(--danger)">æ³¨æ„ï¼šè¦†ç›–æ“ä½œä¸å¯æ’¤é”€ã€‚</div>
        `

					showConfirmModal(tableHtml, () => doAdd('update'), true)
					document.getElementById('confirmActionBtn').innerText = 'è¦†ç›–ä¿å­˜'
				} else {
					// 2.5 æ— é‡å¤ -> ç›´æ¥æ·»åŠ 
					await doAdd('skip')
				}
			}

			function resetForm() {
				document.getElementById('editId').value = ''
				document.querySelectorAll('#tab-single input').forEach((i) => (i.value = ''))
				document.getElementById('cancelEdit').classList.add('hidden')
			}

			function showLogin() {
				document.getElementById('loginModal').classList.remove('hidden')
			}
			// æ›¿æ¢åŸæœ‰çš„ confirmLogin å‡½æ•°
			async function confirmLogin() {
				const pass = document.getElementById('modalPass').value

				// 1. ç¦ç”¨æŒ‰é’®é˜²æ­¢é‡å¤æäº¤
				const btn = document.querySelector('#loginModal .btn-primary')
				const originalText = btn.innerText
				btn.innerText = 'éªŒè¯ä¸­...'
				btn.disabled = true

				try {
					// 2. å‘é€è¯·æ±‚ç»™åç«¯éªŒè¯
					const res = await fetch('/api/verify', {
						method: 'POST',
						headers: { 'Content-Type': 'application/json' },
						body: JSON.stringify({ password: pass }),
					})

					const data = await res.json()

					// 3. æ ¹æ®åç«¯è¿”å›ç»“æœåˆ¤æ–­
					if (res.ok && data.success) {
						localStorage.setItem('adminKey', pass)
						closeModal('loginModal')
						toggleAdmin(true)
						showToast('ç™»å½•æˆåŠŸ')
						// æ¸…ç©ºè¾“å…¥æ¡†ï¼Œé˜²æ­¢ä¸‹æ¬¡æ‰“å¼€è¿˜èƒ½çœ‹åˆ°å¯†ç 
						document.getElementById('modalPass').value = ''
					} else {
						showToast('å¯†ç é”™è¯¯', 'error')
						// ç™»å½•å¤±è´¥æ¸…é™¤é”™è¯¯çš„ keyï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰
						localStorage.removeItem('adminKey')
					}
				} catch (e) {
					console.error(e)
					showToast('ç½‘ç»œè¯·æ±‚å¤±è´¥', 'error')
				} finally {
					// 4. æ¢å¤æŒ‰é’®çŠ¶æ€
					btn.innerText = originalText
					btn.disabled = false
				}
			}
			// æ–°å¢ï¼šç™»å‡ºç¡®è®¤
			function confirmLogout() {
				// å¤ç”¨é€šç”¨çš„ confirmModalï¼Œæ ·å¼æ›´ç»Ÿä¸€
				showConfirmModal('ç¡®å®šè¦é€€å‡ºç™»å½•å—ï¼Ÿ', () => {
					localStorage.removeItem('adminKey')
					toggleAdmin(false)
					showToast('å·²é€€å‡ºç™»å½•')
				})
			}

			function logout() {
				localStorage.removeItem('adminKey')
				toggleAdmin(false)
			}
			function toggleAdmin(show) {
				document.getElementById('adminPanel').classList.toggle('hidden', !show)
				document.getElementById('loginBtn').classList.toggle('hidden', show)
				document.getElementById('logoutBtn').classList.toggle('hidden', !show)
				if (document.querySelector('table')) doSearch()
			}
			function showToast(msg, type) {
				const t = document.getElementById('toast')
				t.innerText = msg
				t.className = `toast show ${type || ''}`
				setTimeout(() => (t.className = 'toast'), 2000)
			}

			// --- 7. å¯¼å‡ºåŠŸèƒ½ ---

			function showExportModal() {
				document.getElementById('exportModal').classList.remove('hidden')
				document.getElementById('exportDelimSelect').value = ',' // é»˜è®¤é€—å·
				toggleExportCustom()
			}

			function toggleExportCustom() {
				const val = document.getElementById('exportDelimSelect').value
				const customInput = document.getElementById('exportCustomDelim')
				if (val === 'custom') {
					customInput.classList.remove('hidden')
					customInput.focus()
				} else {
					customInput.classList.add('hidden')
				}
			}

			async function executeExport() {
				const btn = document.getElementById('btnExecuteExport')
				const originalText = btn.innerText
				btn.disabled = true
				btn.innerText = 'æ­£åœ¨ç”Ÿæˆ...'

				try {
					// 1. ç¡®å®šåˆ†éš”ç¬¦
					const selectVal = document.getElementById('exportDelimSelect').value
					let delim = selectVal
					if (selectVal === 'custom') {
						delim = document.getElementById('exportCustomDelim').value
					}
					if (!delim) {
						showToast('è¯·è¾“å…¥åˆ†éš”ç¬¦', 'error')
						btn.disabled = false
						btn.innerText = originalText
						return
					}

					// 2. è·å–æ•°æ®
					const q = document.getElementById('searchInput').value.trim()
					const mode = document.querySelector('input[name="mode"]:checked').value

					// --- æ ¸å¿ƒä¿®æ”¹ï¼šæ·»åŠ  export=true å‚æ•° ---
					// æ­¤æ—¶ limit å‚æ•°ä¸å†é‡è¦ï¼Œå› ä¸ºåç«¯çœ‹åˆ° export=true ä¼šå¿½ç•¥ limit å¤§å°
					const res = await fetch(`/api/search?q=${encodeURIComponent(q)}&page=1&limit=99999&mode=${mode}&export=true`)

					const json = await res.json()
					const data = json.data

					if (!data || data.length === 0) {
						showToast('æ²¡æœ‰æ•°æ®å¯å¯¼å‡º', 'error')
						closeModal('exportModal')
						return
					}

					// 3. æ„å»º CSV å†…å®¹
					const rows = data.map((item) => {
						return [
							item.base_word || '',
							item.past_tense || '',
							item.past_participle || '',
							item.definition || '',
							item.note || '',
						].join(delim)
					})

					// æ·»åŠ  BOM é˜²æ­¢ä¹±ç 
					const csvContent = '\uFEFF' + rows.join('\n')

					// 4. è§¦å‘ä¸‹è½½
					const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' })
					const url = URL.createObjectURL(blob)
					const link = document.createElement('a')

					const date = new Date().toISOString().slice(0, 10).replace(/-/g, '')
					const ext = selectVal === '	' ? 'txt' : 'csv'
					link.setAttribute('href', url)

					// æ ¹æ®æ˜¯å¦æœç´¢äº†å†…å®¹æ¥å‘½åæ–‡ä»¶ï¼Œæ–¹ä¾¿ç”¨æˆ·åŒºåˆ†
					const fileNamePrefix = q ? `verbs_search_${q}` : `verbs_all`
					link.setAttribute('download', `${fileNamePrefix}_${date}.${ext}`)

					document.body.appendChild(link)
					link.click()
					document.body.removeChild(link)

					showToast(`æˆåŠŸå¯¼å‡º ${data.length} æ¡æ•°æ®`)
					closeModal('exportModal')
				} catch (e) {
					console.error(e)
					showToast('å¯¼å‡ºå¤±è´¥', 'error')
				} finally {
					btn.disabled = false
					btn.innerText = originalText
				}
			}
		</script>
	</body>
</html>
